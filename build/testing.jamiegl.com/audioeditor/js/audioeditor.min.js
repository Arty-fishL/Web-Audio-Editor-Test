function onDragInside(e){e.stopPropagation(),e.preventDefault(),clearTimeout(g_dragExitTimeout),$("main").addClass("dropzone-ready");for(var types=e.originalEvent.dataTransfer.types,i=0;i<types.length;i++)if(types[i].indexOf("audio")>-1)return!0;return!1}function onSoundFilesSelected(files){for(var i=0;i<files.length;i++){var file=files[i];file.type.indexOf("audio")>-1&&loadSoundFile(file)}}function loadSoundFile(file){console.log("Loading audio file: "+file.name);var track={filename:file.name,wave:null,muted:!1,number:g_tracklist.length+1};g_tracklist.push(track);var title=generateTitleForTrack(track),id="container-track-"+track.number,$item=$("#container-track-template").clone().attr("id",id).attr("data-track-num",track.number).removeClass("hidden");$item.find(".mdc-card__primary input").val(title);var wavesurfer=WaveSurfer.create({container:$item.find(".track-waveform").get(0),waveColor:"#3F51B5",progressColor:"#303F9F",cursorColor:"#009688",hideScrollbar:!0,scrollParent:!0,autoCenter:!0,fillParent:!1});wavesurfer.loadBlob(file),track.wave=wavesurfer;var lastSeek=0;wavesurfer.on("seek",function(progress){if(thisSeek=Date.now(),thisSeek-lastSeek<20)return lastSeek=thisSeek,!1;lastSeek=thisSeek;for(var secs=wavesurfer.getCurrentTime(),i=0;i<g_tracklist.length;i++){var wave2=g_tracklist[i].wave,duration=wave2.getDuration();secs>=duration?(wave2.seekTo(1),wave2.pause()):(wave2.seekTo(1*secs/duration),g_playing&&wave2.play())}}),wavesurfer.on("finish",function(e){for(var i=0;i<g_tracklist.length;i++)if(g_tracklist[i].wave.isPlaying())return;stop()}),$("#container-add").before($item),window.mdc.autoInit(),$item.find(".action-remove").on("click",function(){removeTrack(track)}),$item.find(".action-mute").on("click",function(){toggleTrackMute(track)}),$("#fab").addClass("show")}function generateTitleForTrack(track){var title=track.filename.trim().replace(/\.[^.]*$/,"");title.length<=0&&(title="Track "+track.number);for(var origTitle=title,i=1;;){var matched=!1;if($(".container-track:not(#container-track-template)").each(function(){if($(this).find(".mdc-card__primary input").val()==title)return matched=!0,!1}),!matched)break;i>1&&(title=origTitle+" ("+i+")"),i++}return title}function removeTrack(track){track.wave.destroy();var index=g_tracklist.indexOf(track);g_tracklist.splice(index,1),$(".container-track[data-track-num="+track.number+"]").remove(),g_tracklist.length<=0&&$("#fab").removeClass("show")}function toggleTrackMute(track){track.muted=!track.muted,track.muted?track.wave.setVolume(0):track.wave.setVolume(1),$(".container-track[data-track-num="+track.number+"] .action-mute").html(track.muted?"UNMUTE":"MUTE")}function togglePlay(){g_playing?stop():play()}function play(){g_playing=!0,$(".mdc-fab__icon").html("stop");for(var i=0;i<g_tracklist.length;i++)g_tracklist[i].wave.play()}function stop(){g_playing=!1,$(".mdc-fab__icon").html("play_arrow");for(var i=0;i<g_tracklist.length;i++)g_tracklist[i].wave.stop()}var g_tracklist=[],g_playing=!1,g_dragExitTimeout=null;$(function(){mdc.toolbar.MDCToolbar.attachTo(document.querySelector(".mdc-toolbar")).fixedAdjustElement=document.querySelector(".mdc-toolbar-fixed-adjust"),window.mdc.autoInit();$(document).on("dragenter",function(e){return e.originalEvent.dataTransfer.effectAllowed="link",onDragInside(e)}).on("dragover",function(e){return e.stopPropagation(),e.preventDefault(),e.originalEvent.dataTransfer.dropEffect="link",onDragInside(e)}).on("dragleave dragexit dragend",function(e){e.stopPropagation(),e.preventDefault(),clearTimeout(g_dragExitTimeout),g_dragExitTimeout=setTimeout(function(){$("main").removeClass("dropzone-ready")},100)}).on("drop",function(e){e.preventDefault(),$("main").removeClass("dropzone-ready"),onSoundFilesSelected(e.originalEvent.dataTransfer.files)}),$("#overlay-dropzone-ready").click(function(){$("main").removeClass("dropzone-ready")}),$("#container-add button").click(function(){$("#add-file-input").click()}),$("#add-file-input").on("change",function(){onSoundFilesSelected($(this).prop("files"))})});